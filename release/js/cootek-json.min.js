/*!  2015-09-17 */
function getIdPrefix(sectionObj){return sectionObj&&sectionObj.type?sectionObj.type:"Cootek"+ID_COUNT++}function inRequiredItemByModel(ngModelString){for(var reg=/\[(\w+)\]|\['(\w+)'\]/g,valueArr=[],item=null;null!==(item=reg.exec(ngModelString));)valueArr.push(item[1]||item[2]);return inRequiredItemByValueArray(valueArr)}function inRequiredItemById(idString){return inRequiredItemByModel(getModelStringByIdString(idString))}function inRequiredItemByValueArray(arr){for(var subRequiredItem=requiredItem,i=0;i<arr.length;i++)if(void 0!==subRequiredItem[arr[i]])subRequiredItem=subRequiredItem[arr[i]];else{if(!$.isArray(subRequiredItem)||void 0===subRequiredItem[0])return!1;subRequiredItem=subRequiredItem[0]}return!0}function getModelStringByIdString(idString){for(var arr=idString.split("-"),modelString="jsonCodeSections["+sectionOrder[arr[0]]+"]",i=1,len=arr.length;len>i;i++)modelString+="['"+arr[i]+"']";return modelString}$(document).ready(function(){$("#json-affix").affix({offset:{top:$("#json-affix").offset().top,bottom:$("#footer").outerHeight()+60}}),$('[data-toggle="tooltip"]').tooltip(),window.onscroll=function(){var top=document.body.scrollTop||document.documentElement.scrollTop;top>=100?$("#header-nav").addClass("display-none"):$("#header-nav").removeClass("display-none")}});var app=angular.module("cootek-json",[]),TEXTAREA_DEFAULT_ROWS=3,TEXTAREA_EDITING_ROWS=25,sectionTitles={wuxichen1:"推荐项目",wuxichen2:"我的订单",wuxichen3:"猜你喜欢",wuxichen4:"分割符",wuxichen5:"线下服务",wuxichen6:"优惠券"},sectionOrder={},ID_COUNT=1;requiredItem={},app.controller("IndexJSONController",function($scope,$compile,$timeout){function getJSONCode(){return $scope.isServer||($scope.jsonCode=jsonByScript),$scope.jsonCode}function getJSONString(json){return json||(json=$scope.jsonCode?$scope.jsonCode:getJSONCode()),json=json||{},JSON.stringify(json,function(key,value){return"$$hashKey"!==key?value:void 0},4)}function getModelByIdString(idString){for(var arr=idString.split("-"),model=$scope.jsonCodeSections[sectionOrder[arr[0]]],i=1,len=arr.length;len>i;i++){if("undefined"==typeof model)return null;model=model[arr[i]],console.log("aa")}return model}function insertVariableToModel(type,key,parent){if("string"==typeof parent&&(parent=getModelByIdString(parent)),key in parent)return!1;switch(type){case"0":parent[key]="";break;case"1":parent[key]=!0;break;case"2":parent[key]=[];break;case"3":parent[key]={}}return!0}function updateAllDOMElements(){var oldRoot=angular.element("#jsoncode-dom"),newRoot=$compile('<section class="module clearfix" ng-repeat="section in jsonCodeSections"><div id="{{ section.type }}" class="module-title"><h4>{{ getSectionTitle(section.type) }}模块</h4></div><div id="{{ section.type }}" cootek-json-repeat section-obj="section" section-index="$index" class="clearfix"></div></section>')($scope);oldRoot.append(newRoot)}function updateSidebarNav(){angular.element("#json-affix-content").replaceWith($compile('<ul id="json-affix-content" class="sidebar-nav nav panel-body"><li ng-repeat="section in jsonCodeSections | filter: section.type = \'!separator\'"><a ng-href="#{{section.type}}">{{ getSectionTitle(section.type) }}模块</a><ul cootek-json-nav section-obj="section" class="nav"></ul><li></ul>')($scope))}function deleteModelById(idString){var idArr=idString.split("-");if(1===idArr.length);else{var parentModel=getModelByIdString(idArr.slice(0,-1).join("-"));console.log(parentModel),parentModel&&void 0!==parentModel[idArr[idArr.length-1]]&&($.isArray(parentModel)?(console.log(parentModel[parseInt(idArr[idArr.length-1])]),parentModel.splice(parseInt(idArr[idArr.length-1]),1)):(console.log(parentModel[idArr[idArr.length-1]]),delete parentModel[idArr[idArr.length-1]],delete parentModel[idArr[idArr.length-1]]))}}function updateModelById(idString,key){var idArr=idString.split("-");if(1===idArr.length);else{var parentModel=getModelByIdString(idArr.slice(0,-1).join("-")),parentModelCopy={};if(parentModel&&void 0!==parentModel[idArr[idArr.length-1]])if($.isArray(parentModel))parentModel.splice(parseInt(idArr[idArr.length-1]),1);else{for(var parentModelitem in parentModel)idArr[idArr.length-1]!=parentModelitem?parentModelCopy[parentModelitem]=parentModel[parentModelitem]:(deleteNodeContent=parentModel[idArr[idArr.length-1]],parentModelCopy[key]=deleteNodeContent);var model=$scope.jsonCodeSections[sectionOrder[idArr[0]]],arr1=[],model1=$scope.jsonCodeSections[sectionOrder[idArr[0]]];if(2===idArr.length)$scope.jsonCodeSections[sectionOrder[idArr[0]]]=parentModelCopy;else{for(var i=1,len=idArr.length-1;len>i;i++){if("undefined"==typeof model)return null;model=model[idArr[i]],arr1.push(i)}for(var j=0,len1=arr1.length-1;len1>j;j++)model1=model1[idArr[arr1[j]]];model1[idArr[arr1[len1]]]=parentModelCopy}}}}function updateDOMElements(Node,idString){if(void 0!==Node&&void 0!==idString){var modelString=getModelStringByIdString(idString),newNodeString='<div cootek-json-repeat id="'+idString+'" class="module-content" section-obj="'+modelString+'" model-string="\''+modelString.replace(/'/g,"\\'")+"'\" id-string=\"'"+idString+"'\"></div>";angular.element(Node).replaceWith($compile(newNodeString)($scope))}}function showSuccessLabel(text,time){$scope.showSuccessLabel=!0,$scope.successLabel=text||"",time=time||3,$timeout(function(){$scope.showSuccessLabel=!1},1e3*time)}function showErrorLabel(text,time){$scope.showErrorLabel=!0,$scope.errorLabel=text||"",time=time||3,$timeout(function(){$scope.showErrorLabel=!1},1e3*time)}function checkForm(){var checkModelObject=function(required,ngModel,idPrefix){if($.isArray(required)&&1===required.length)for(var key=0;key<ngModel.length;key++){var idString=idPrefix+"-"+key;if(!checkModelObject(required[0],ngModel[key],idString))return!1}else for(var key in required)if(required.hasOwnProperty(key)){var idString=idPrefix+"-"+key;if(void 0===ngModel[key])return window.location.hash="#"+idString,$("#"+idString)[0].focus(),!1;if(!checkModelObject(required[key],ngModel[key],idString))return!1}return!0};for(var key in requiredItem)if(requiredItem.hasOwnProperty(key)&&!checkModelObject(requiredItem[key],$scope.jsonCodeSections[key],$scope.jsonCodeSections[key].type))return!1;return!0}$scope.jsoncodeEditable=!0,$scope.jsonCode=getJSONCode(),$scope.jsonCodeString=getJSONString($scope.jsonCode),$scope.jsonCodeSections=$scope.jsonCode.sections,$scope.showSuccessLabel=!1,$scope.showErrorLabel=!1,$scope.successLabel="",$scope.errorLabel="",$scope.getSectionTitle=function(type){return sectionTitles[type]?sectionTitles[type]:""},$scope.textAreaFocus=function($event){$event.target.rows=TEXTAREA_EDITING_ROWS},$scope.textAreaBlur=function($event){$event.target.rows=TEXTAREA_DEFAULT_ROWS},$scope.editJsonCode=function(){$scope.jsoncodeEditable=!0,setTimeout(function(){$("#jsoncodetext").focus()},10)},$scope.copyJsonCode=function(event){var textarea=$("#jsoncodetext")[0];"undefined"!=typeof textarea.setSelectionRange?($scope.jsoncodeEditable=!0,textarea.setSelectionRange(0,textarea.value.length),showSuccessLabel("全选成功 请使用Ctrl+C",5),setTimeout(function(){textarea.focus()},10)):(event.currentTarget.setAttribute("data-original-title",'请全选后按"Ctrl+C"'),$(".glyphicon-paste").tooltip("show"),event.currentTarget.setAttribute("data-original-title","复制"))},$scope.generateCode=function(){checkForm()?($scope.jsonCodeString=getJSONString($scope.jsonCode),$scope.jsoncodeEditable=!1,showSuccessLabel("JSON代码生成成功！",3)):showErrorLabel("必填项尚未完全填写！")},$scope.generateDOM=function(){$scope.jsonCode=JSON.parse($scope.jsonCodeString),$scope.jsonCodeSections=$scope.jsonCode.sections,updateAllDOMElements(),updateSidebarNav(),showSuccessLabel("成功由JSON代码生成结构！",7)},$scope.chooseRadio=function(idString,value){var parentIdString=idString.split("-").slice(0,-1).join("-"),key=idString.split("-").slice(-1),modelParent=getModelByIdString(parentIdString);modelParent[key]=Boolean(value)},$scope.addItemClick=function(event,isArray){$scope.addItem={isArray:Boolean(isArray)},$scope.addItemParent=event.currentTarget.parentNode.parentNode||null},$scope.addItem={},$scope.addItemParent=null,$scope.addConfirm=function(){if(!(null===$scope.addItemParent||parseInt($scope.addItem.type)>3||parseInt($scope.addItem.type)<0)){$scope.addItem.key=$scope.addItem.key||"";var parentModel=getModelByIdString($scope.addItemParent.id),key=$scope.addItem.key||parentModel.length;insertVariableToModel($scope.addItem.type,key,parentModel)?(updateDOMElements($scope.addItemParent,$scope.addItemParent.id),updateSidebarNav()):showErrorLabel("无法添加相同名称的item")}},$scope.changeItemClick=function(event,idString){$scope.toChangeElement=event.currentTarget.parentNode.parentNode||null,$scope.changeItemParent=event.target.parentNode||null,$scope.changeItemIndexType=idString.split("-"),$scope.changeItemIndex=idString||"",$("#item-change").find("input").attr("placeholder",$scope.changeItemIndexType[$scope.changeItemIndexType.length-1]),$("#item-change").find("input").val("")},$scope.changeItem={},$scope.changeItemParent=null,$scope.changeItemIndex="",$scope.changeItemIndexType=[],$scope.changeConfirm=function(){null!==$scope.changeItemParent&&(console.log($("#item-change").find("input").attr("placeholder")),""===$("#item-change").find("input").val()&&($scope.changeItem.key=$("#item-change").find("input").attr("placeholder")),console.log("----------------"),console.log($scope.changeItem.key),updateModelById($scope.changeItemIndex,$scope.changeItem.key),updateDOMElements($scope.toChangeElement.parentNode,$scope.changeItemIndex.split("-").slice(0,-1).join("-")),updateSidebarNav())},$scope.deleteItemClick=function(event,idString){$scope.toDeleteElement=event.currentTarget.parentNode.parentNode||null,$scope.toDeleteId=idString||""},$scope.toDeleteElement=null,$scope.toDeleteId="",$scope.deleteConfirm=function(){console.log("close"),null!==$scope.toDeleteElement&&""!==$scope.toDeleteId&&(deleteModelById($scope.toDeleteId),updateDOMElements($scope.toDeleteElement.parentNode,$scope.toDeleteId.split("-").slice(0,-1).join("-")),updateSidebarNav())}}),app.directive("cootekJsonRepeat",function($compile){return{restrict:"EA",replace:!0,scope:{sectionObj:"=",sectionIndex:"=",modelString:"=",idString:"="},link:function(scope,ele){function constructAngularElement(parent,childObj,idPrefix,ngModelPrefix){for(var key in childObj)if("$$hashKey"!==key&&childObj.hasOwnProperty(key)){var idString=idPrefix+"-"+key,ngModelString=ngModelPrefix+(isNaN(key)?"['"+key+"']":"["+key+"]"),isRequired=inRequiredItemByModel(ngModelString),row=null,label=null,contentRequired="",disabledInput="type"===key&&/jsonCodeSections\[\d+\]$/g.test(ngModelPrefix)?"disabled":"";isRequired?(row=angular.element('<div class="module-row clearfix" ng-class="{\'has-error\':'+ngModelString+'===undefined}"></div>'),row=$compile(row)(scope.$parent),label=angular.element('<label for="'+idString+'" class="module-item">'+key+'<span class="required-item"></span>:</label>'),contentRequired="required"):(row=angular.element('<div class="module-row clearfix"></div>'),label=$.isArray(childObj)?angular.element('<label for="'+idString+'" class="module-item">'+key+':<span class="glyphicon glyphicon-remove module-remove" ng-click="deleteItemClick($event,\''+idString+'\')" data-toggle="modal" href="#delete-item"></span></label>'):angular.element('<label for="'+idString+'" class="module-item">'+key+':<span class="glyphicon glyphicon-edit module-edit" data-toggle="modal" ng-click="changeItemClick($event,\''+idString+'\')"  href="#item-change"></span><span class="glyphicon glyphicon-remove module-remove" ng-click="deleteItemClick($event,\''+idString+'\')" data-toggle="modal" href="#delete-item"></span></label>')),label=$compile(label)(scope.$parent);var content="";"string"==typeof childObj[key]||"number"==typeof childObj[key]?(content='<input id="'+idString+'" name="'+idString+'" class="form-control module-content" ng-model="'+ngModelString+'" '+contentRequired+" "+disabledInput+">",content=$compile(content)(scope.$parent)):"boolean"==typeof childObj[key]?(content='<div id= "'+idString+'" class="btn-group module-content"><button type="button" class="btn btn-default dropdown-toggle radio-btn" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">{{'+ngModelString+'}}<span class="caret"></span></button><ul class="dropdown-menu"><li><a href ng-click="chooseRadio(\''+idString+"', true)\">ture</a></li><li><a href ng-click=\"chooseRadio('"+idString+"', false)\">false</a></li></ul></div>",content=$compile(content)(scope.$parent)):(content=angular.element('<div id="'+idString+'" class="module-content"></div>'),content=arguments.callee(content,childObj[key],idString,ngModelString)),row.append(label),row.append(content),parent.append(row)}var addItemDisabled=!1;"object"==typeof childObj[key]&&"itemRecommands"in childObj[key]&&(addItemDisabled=!0);var addItemBtn='<div class="module-row"><a href="#add-item" class="btn btn-primary btn-block btn-large'+(addItemDisabled?" disabled":"")+'" ng-click="addItemClick($event,'+$.isArray(childObj)+')" data-toggle="modal"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span></a></div>';return parent.append($compile(addItemBtn)(scope.$parent)),parent}var idPrefix=void 0===scope.idString?getIdPrefix(scope.sectionObj):scope.idString,tplEl=angular.element(ele);void 0!==scope.sectionIndex&&(sectionOrder[idPrefix]=scope.sectionIndex);var ngModelString="";void 0!==scope.modelString?ngModelString=scope.modelString:void 0!==scope.sectionIndex&&(ngModelString="jsonCodeSections["+scope.sectionIndex+"]"),tplEl=constructAngularElement(tplEl,scope.sectionObj,idPrefix,ngModelString),ele.replaceWith(tplEl)}}}),app.directive("cootekJsonNav",function($compile){return{restrict:"EA",replace:!1,scope:{sectionObj:"="},link:function(scope,ele){var maxDepth=6;!function constructAngularNav(parent,childObj,idPrefix,depth){if(depth>maxDepth)return null;var flag=0;for(var key in childObj)if("$$hashKey"!==key&&childObj.hasOwnProperty(key)){var idString=idPrefix+"-"+key,content="";if("object"==typeof childObj[key]){for(var subKey in childObj[key]){if("title"===subKey){flag=1;break}if("name"===subKey){flag=2;break}}content=1===flag?angular.element('<li><a href="#'+idString+'">'+key+"&nbsp;&nbsp;["+childObj[key].title+"]</a></li>"):0===flag?angular.element('<li><a href="#'+idString+'">'+key+"</a></li>"):angular.element('<li><a href="#'+idString+'">'+key+"&nbsp;&nbsp;["+childObj[key].name+"]</a></li>");var list=constructAngularNav(angular.element('<ul class="nav"></ul>'),childObj[key],idString,depth+1);content.append(list)}else content=angular.element('<li><a href="#'+idString+'">'+key+"</a></li>");parent.append(content)}return parent}(ele,scope.sectionObj,getIdPrefix(scope.sectionObj),0)}}});
/*! cootek_json 最后修改于： 2015-09-17 */